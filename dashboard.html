<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>داشبورد - ویرایشگر مانگا</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <style>
    body {
      margin:0; height:100vh; background:#0b0b0b; color:#eee; font-family: system-ui, sans-serif;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      text-align:center; overflow:hidden;
    }
    h1 { margin:0.4em 0; font-size:2.1rem; color:#0af; }
    .token-box {
      background:#1a1a1a; border:1px solid #444; border-radius:12px;
      padding:1.2rem 2.5rem; margin:1.5rem 0; font-size:1.35rem;
      box-shadow:0 0 30px rgba(0,170,255,0.15);
    }
    .glow-button-wrapper {
      position:relative; width:320px; height:100px; margin:2rem 0;
    }
    .glow-button {
      position:absolute; inset:0; border:none; border-radius:999px;
      background:#0af; color:white; font-size:1.5rem; font-weight:bold;
      cursor:pointer; z-index:2; box-shadow:0 8px 30px rgba(0,0,0,0.5);
      transition: all 0.25s;
    }
    .glow-button:hover { transform:scale(1.06); box-shadow:0 12px 40px rgba(0,170,255,0.4); }
    .glow-button:disabled { background:#555; cursor:not-allowed; box-shadow:none; }
    .border-glow {
      position:absolute; inset:-8px; border-radius:999px; pointer-events:none; z-index:1;
      background: conic-gradient(
        from 0deg at 50% 50%,
        #0af, #f0f, #0ff, #0f0, #ff0, #f80, #f00, #0af
      );
      animation: rotate 10s steps(8) infinite; /* کندتر + مکث با steps */
      filter: blur(12px) brightness(1.3);
    }
    @keyframes rotate {
      100% { transform:rotate(360deg); }
    }
    .info-text {
      max-width:520px; line-height:1.7; font-size:1.1rem; color:#ccc; margin-top:2rem;
      padding:0 1.5rem;
    }
    .back-btn {
      margin-top:3rem; padding:0.9rem 2rem; font-size:1.1rem;
      background:#333; color:#aaa; border:1px solid #555; border-radius:8px;
      cursor:pointer;
    }
  </style>
</head>
<body onload="checkAuth();">

<h1>ویرایشگر مانگا - داشبورد</h1>

<div class="token-box">
  در حال حاضر شما <strong id="tokenCount">---</strong> توکن دارید
</div>

<div class="glow-button-wrapper">
  <div class="border-glow"></div>
  <button class="glow-button" id="enterEditorBtn" disabled>
    ورود به ویرایشگر
  </button>
</div>

<div class="info-text">
  در حال حاضر بخاطر شلوغی سرور و قیمت بالای سرور، کاربران محدود شده‌اند.<br>
  شما برای هر چپتر <strong>۶ ساعت</strong> مهلت دارید تا تایپ و ویرایش خودتون رو انجام بدید.<br>
  توجه: بعد از ۶ ساعت توکن شما می‌سوزه و به این صفحه برمی‌گردید.<br>
  پس لطفاً وقتی زمان کافی دارید دکمه ورود را بزنید.
</div>

<button class="back-btn" onclick="history.back()">بازگشت</button>

<script>
  const AUTH_KEY = "mangaEditorAuth";
  const STORAGE_KEY = "mangaEditorSession";
  const SESSION_DURATION = 6 * 60 * 60 * 1000; // ۶ ساعت

  function checkAuth() {
    const auth = getAuth();
    if (!auth || !auth.loggedIn) {
      window.location.href = "login.html";
      return;
    }
    updateTokenDisplay();
  }

  function getAuth() {
    const data = localStorage.getItem(AUTH_KEY);
    if (!data) return null;
    try { return JSON.parse(data); }
    catch { return null; }
  }

  function getSession() {
    const data = localStorage.getItem(STORAGE_KEY);
    if (!data) return null;
    try { return JSON.parse(data); }
    catch { return null; }
  }

  function createNewSession() {
    const auth = getAuth();
    if (auth.tokens <= 0) {
      alert("توکن‌های شما تمام شده است.");
      return null;
    }

    const now = Date.now();
    const session = {
      start: now,
      expire: now + SESSION_DURATION,
      usedToken: true
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(session));

    // سوزاندن یک توکن
    auth.tokens -= 1;
    localStorage.setItem(AUTH_KEY, JSON.stringify(auth));

    return session;
  }

  function updateTokenDisplay() {
    const auth = getAuth();
    const sess = getSession();
    const tokenEl = document.getElementById("tokenCount");
    const btn = document.getElementById("enterEditorBtn");

    if (!auth) {
      tokenEl.textContent = "۰";
      tokenEl.style.color = "#e33";
      btn.disabled = true;
      return;
    }

    tokenEl.textContent = auth.tokens;
    tokenEl.style.color = auth.tokens > 0 ? "#0f8" : "#e33";

    if (auth.tokens <= 0) {
      btn.disabled = true;
      btn.textContent = "توکن تمام شده";
      return;
    }

    if (sess) {
      const remainMs = sess.expire - Date.now();
      if (remainMs <= 0) {
        localStorage.removeItem(STORAGE_KEY);
        btn.disabled = false;
        btn.textContent = "شروع جلسه جدید";
        return;
      }
      const hours = Math.floor(remainMs / 3600000);
      const mins = Math.floor((remainMs % 3600000) / 60000);
      tokenEl.textContent += ` (∼ \( {hours}س \){mins}د)`;
      btn.disabled = false;
      btn.textContent = "ادامه ویرایش";
    } else {
      btn.disabled = false;
      btn.textContent = "شروع جلسه جدید";
    }
  }

  document.getElementById("enterEditorBtn").onclick = () => {
    let sess = getSession();

    if (sess && (sess.expire - Date.now() > 0)) {
      window.location.href = "index.html";
      return;
    }

    sess = createNewSession();
    if (sess) {
      updateTokenDisplay();
      window.location.href = "index.html";
    }
  };

  setInterval(updateTokenDisplay, 30000);
  updateTokenDisplay();
</script>
</body>
</html>
